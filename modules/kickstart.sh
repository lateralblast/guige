# Function: create_kickstart_iso
#
# Create kickstart ISO (e.g. Rocky Linux)

create_kickstart_iso () {
  if [ ! -f "/usr/bin/xorriso" ]; then
    install_required_packages
  fi
  if [ "$TEST_MODE" = "false" ]; then
    handle_output "# Creating ISO" TEXT
    check_file_perms "$OUTPUT_FILE"
    cd $ISO_NEW_DIR/cd 
    sudo mkisofs -o "$OUTPUT_FILE" -b isolinux/isolinux.bin -c isolinux/boot.cat \
    -boot-load-size 4 -boot-info-table -no-emul-boot -eltorito-alt-boot \
    -eltorito-boot images/efiboot.img -no-emul-boot -R -J -V "$ISO_LABEL" -T .
    check_file_perms "$OUTPUT_FILE"
  fi
}

# Function: create_kickstart_file
#
# Create kickstart files (e.g. Rocky Linux)

prepare_kickstart_files () {
  KS_DIR="$ISO_NEW_DIR/cd/kickstart"
  if [ "$TEST_MODE" = "false" ]; then
    if [ ! -d "$KS_DIR" ]; then
      sudo mkdir -p "$KS_DIR"
    fi
  fi
  for ISO_VOLMGR in $ISO_VOLMGRS; do
    KS_FILE="$WORK_DIR/files/$ISO_VOLMGR.ks"
    DATE=$( date )
    echo "# Kistart file generated by $SCRIPT_NAME on $DATE" > "$KS_FILE"
    if [ "$DO_MEDIA_CHECK" = "true" ]; then
      echo "mediacheck" >> "$KS_FILE"
    fi
#    echo "$ISO_INSTALL_MODE" >> "$KS_FILE"
    echo "$ISO_INSTALL_SOURCE" >> "$KS_FILE"
    echo "%pre" >> "$KS_FILE"
    if [ "$ISO_DISK" = "first-disk" ]; then
      echo "FIRST_DISK=\$(lsblk -x TYPE|grep disk |sort |head -1 |awk '{print \$1}')" >> "$KS_FILE"
      echo "export \$FIRST_DISK" >> "$KS_FILE"
    fi
    if [ "$ISO_NIC" = "first-nic" ]; then
      echo "FIRST_NIC=\$(lshw -class network -short |awk '{print \$2}' |grep ^e |head -1)" >> "$KS_FILE"
      echo "export \$FIRST_NIC" >> "$KS_FILE"
    fi
    echo "%end" >> "$KS_FILE"
    echo "lang $ISO_LOCALE" >> "$KS_FILE"
    echo "keyboard $ISO_COUNTRY" >> "$KS_FILE"
    echo "timezone --utc $ISO_TIMEZONE" >> "$KS_FILE"
    echo "firstboot --$DO_ISO_FIRSTBOOT" >> "$KS_FILE"
    if [ "$ISO_DISK" = "first-disk" ]; then
      echo "bootloader --timeout=$ISO_GRUB_TIMEOUT --location=$ISO_BOOT_LOADER_LOCATION --append=\"$ISO_KERNEL_ARGS\" --boot-drive=\$FIRST_DISK" >> "$KS_FILE"
      echo "clearpart --all --drives=\$FIRST_DISK" >> "$KS_FILE"
    else
      echo "bootloader --timeout=$ISO_GRUB_TIMEOUT --location=$ISO_BOOT_LOADER_LOCATION --append=\"$ISO_KERNEL_ARGS\" --boot-drive=$ISO_DISK" >> "$KS_FILE"
      echo "clearpart --all --drives=$ISO_DISK" >> "$KS_FILE"
    fi
    if [ "$ISO_VOLMGR" = "lvm" ]; then
      echo "autopart --type=lvm" >> "$KS_FILE"
    else
      if [ "$ISO_DISK" = "first-disk" ]; then
        echo "part /boot --size=$ISO_BOOT_SIZE --fstype=\"$ISO_VOLMGR\" --ondisk=\$FIRST_DISK" >> "$KS_FILE"
        echo "part $ISO_LV_NAME --size=-1 --grow --fstype=\"lvmpv\" --ondisk=\$FIRST_DISK" >> "$KS_FILE"
        echo "part /boot/efi --size=$ISO_BOOT_SIZE --asprimary --fstype=\"efi\" --ondisk=\$FIRST_DISK" >> "$KS_FILE"
      else
        echo "part /boot --size=$ISO_BOOT_SIZE --fstype=\"$ISO_VOLMGR\" --ondisk=$ISO_DISK" >> "$KS_FILE"
        echo "part $ISO_LV_NAME --size=-1 --grow --fstype=\"$ISO_VOLMGR\" --ondisk=$ISO_DISK" >> "$KS_FILE"
        echo "part /boot/efi --size=$ISO_BOOT_SIZE --asprimary --fstype=\"efi\" --ondisk=$ISO_DISK" >> "$KS_FILE"
      fi
      echo "volgroup $ISO_VG_NAME --pesize=$ISO_PE_SIZE $ISO_LV_NAME" >> "$KS_FILE"
      echo "logvol / --fstype $ISO_VOLMGR --vgname $ISO_VG_NAME --size=$ISO_ROOT_SIZE --name=root" >> "$KS_FILE"
      echo "logvol swap --vgname $ISO_VG_NAME --size=$ISO_SWAP_SIZE --name=swap" >> "$KS_FILE"
    fi
#    echo "auth --enableshadow --passalgo=$ISO_PASSWORD_ALGORITHM" >> "$KS_FILE"
    echo "selinux --$ISO_SELINUX" >> "$KS_FILE"
    if [ "$ISO_FIREWALL" = "enabled" ]; then
      echo "firewall --$ISO_FIREWALL --service=$ISO_ALLOW_SERVICE" >> "$KS_FILE"
    else
      echo "firewall --$ISO_FIREWALL" >> "$KS_FILE"
    fi
    if [ "$ISO_NIC" = "first-nic" ]; then
      NETWORK="network --hostname=$ISO_HOSTNAME --bootproto=$ISO_BOOT_PROTO --device=\$FIRST_NIC --onboot=$ISO_ONBOOT"
    else
      NETWORK="network --hostname=$ISO_HOSTNAME --bootproto=$ISO_BOOT_PROTO --device=$ISO_NIC --onboot=$ISO_ONBOOT"
    fi
    if [ "$DO_IPV4" = "false" ]; then
      NETWORK="$NETWORK --noipv4"
    fi
    if [ "$DO_IPV6" = "false" ]; then
      NETWORK="$NETWORK --noipv6"
    fi
    if [ "$DO_ACTIVATE" = "true" ]; then
      NETWORK="$NETWORK --activate"
    else
      NETWORK="$NETWORK --no-activate"
    fi
    if [ "$DO_DEFROUTE" = "false" ]; then
      NETWORK="$NETWORK --nodefroute"
    fi
    if [ "$DO_DHCP" = "false" ]; then
      NETWORK="$NETWORK --ip=$ISO_IP --netmask=$ISO_NETMASK --gateway=$ISO_GATEWAY --nameserver=$ISO_DNS"
    fi
    echo "$NETWORK" >> $KS_FILE 
    echo "services --enabled=$ISO_ENABLE_SERVICE --disabled=$ISO_DISABLE_SERVICE" >> "$KS_FILE"
    if [ "$DO_PLAIN_TEXT_PASSWORD" = "true" ]; then
      ROOT_PW="rootpw --plaintext $ISO_PASSWORD"
      USER_PW="user --name=$ISO_USERNAME --group=$ISO_GROUPS --password=$ISO_PASSWORD --plaintext --gecos=\"$ISO_GECOS\"" >> "$KS_FILE"
      SSH_PW="sshpw --username=$ISO_INSTALL_USERNAME $ISO_INSTALL_PASSWORD"
    else
      ROOT_PW="rootpw --iscrypted $ISO_PASSWORD_CRYPT" >> "$KS_FILE"
      USER_PW="user --name=$ISO_USERNAME --group=$ISO_GROUPS --password=$ISO_PASSWORD_CRYPT --iscrypted --gecos=\"$ISO_GECOS\"" >> "$KS_FILE"
      SSH_PW="sshpw --username=$ISO_INSTALL_USERNAME --iscrypted --password=$ISO_INSTALL_PASSWORD_CRYPT"
    fi
    if [ "$DO_LOCK_ROOT" = "true" ]; then
      ROOT_PW="$ROOT_PW --lock"
    fi
    echo "$ROOT_PW" >> "$KS_FILE"
    echo "$USER_PW" >> "$KS_FILE"
    if [ "$DO_INSTALL_USER" = "true" ]; then
      echo "$SSH_PW" >> "$KS_FILE"
    fi
    echo "%packages" >> "$KS_FILE"
    for PACKAGE in $ISO_INSTALL_PACKAGES; do
      echo "$PACKAGE" >> "$KS_FILE"
    done
    echo "%end" >> "$KS_FILE"
    print_file "$KS_FILE"
    if ! [ -z "$( command -v ksvalidator )" ]; then
      ksvalidator "$KS_FILE"
    fi
    if [ "$TEST_MODE" = "false" ]; then
      sudo cp "$KS_FILE" "$KS_DIR"
    fi
  done
}

# Function: prepare_kickstart_grub_menu
#
# Prepare kickstart grub, isolinux, etc files

prepare_kickstart_grub_menu () {
  TMP_LINUX_CFG="$WORK_DIR/files/isolinux.cfg"
  TMP_GRUB_CFG="$WORK_DIR/files/grub.cfg"
  ISO_LINUX_CFG="$ISO_NEW_DIR/cd/isolinux/isolinux.cfg"
  ISO_GRUB_CFG="$ISO_NEW_DIR/cd/EFI/BOOT/grub.cfg"
  ISO_LABEL="$ISO_OS_NAME-$ISO_MAJOR_RELEASE-$ISO_MINOR_RELEASE-$ISO_ARCH-$ISO_TYPE"
  echo "default $ISO_GRUB_MENU" > "$TMP_LINUX_CFG"
  COUNTER=0
  ISO_KERNEL_SERIAL_ARGS="console=$ISO_SERIAL_PORT0,$ISO_SERIAL_PORT_SPEED0 console=$ISO_SERIAL_PORT1,$ISO_SERIAL_PORT_SPEED1"
  for ISO_DISK in $ISO_DISK; do
    for ISO_VOLMGR in $ISO_VOLMGRS; do
      echo "label $COUNTER" >> "$TMP_LINUX_CFG"
      echo "  menu label ^$ISO_VOLID:$ISO_VOLMGR:$ISO_DISK:$ISO_NIC ($ISO_KERNEL_ARGS)" >> "$TMP_LINUX_CFG"
      echo "  kernel vmlinuz" >> "$TMP_LINUX_CFG"
      echo "  append init.ks=hd:LABEL=$ISO_LABEL/kickstart/$ISO_VOLMGR.ks initrd=initrd.img inst.stage2=hd:LABEL=$ISO_LABEL $ISO_KERNEL_ARGS quiet" >> "$TMP_LINUX_CFG"
      COUNTER=$(( COUNTER+1 ))
    done
  done
  echo "label rescue" >> "$TMP_LINUX_CFG"
  echo "  menu label ^Rescue a Rocky Linux system" >> "$TMP_LINUX_CFG"
  echo "  kernel vmlinuz" >> "$TMP_LINUX_CFG"
  echo "  append initrd=initrd.img inst.stage2=hd:LABEL=$ISO_LABEL inst.rescue quiet" >> "$TMP_LINUX_CFG"
  echo "label memtest" >> "$TMP_LINUX_CFG"
  echo "  menu label Test ^Memory" >> "$TMP_LINUX_CFG"
  echo "  kernel memtest" >> "$TMP_LINUX_CFG"
  echo "label hd" >> "$TMP_LINUX_CFG"
  echo "  menu label ^Boot from first hard drive" >> "$TMP_LINUX_CFG"
  echo "  localboot 0x80" >> "$TMP_LINUX_CFG"
  echo "set timeout=$ISO_GRUB_TIMEOUT" > "$TMP_GRUB_CFG"
  echo "default=$ISO_GRUB_MENU" >> "$TMP_GRUB_CFG"
  echo "loadfont unicode" >> "$TMP_GRUB_CFG"
  for ISO_DISK in $ISO_DISK; do
    for ISO_VOLMGR in $ISO_VOLMGRS; do
      echo "menuentry '$ISO_VOLID:$ISO_VOLMGR:$ISO_DISK:$ISO_NIC ($ISO_KERNEL_SERIAL_ARGS)' {" >> "$TMP_GRUB_CFG"
      echo "  linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=$ISO_LABEL $ISO_KERNEL_ARGS quiet" >> "$TMP_GRUB_CFG"
      echo "  initrdefi /images/pxeboot/initrd.img" >> "$TMP_GRUB_CFG"
      echo "}" >> "$TMP_GRUB_CFG"
    done
  done
  echo "menuentry 'Install $ISO_VOLID ($ISO_KERNEL_SERIAL_ARGS)' {" >> "$TMP_GRUB_CFG"
  echo "  linuxefi /images/pxeboot/vmlinuz init.ks=hd:LABEL=$ISO_LABEL/kickstart/$ISO_VOLMGR.ks inst.stage2=hd:LABEL=$ISO_LABEL $ISO_KERNEL_SERIAL_ARGS quiet" >> "$TMP_GRUB_CFG"
  echo "  initrdefi /images/pxeboot/initrd.img" >> "$TMP_GRUB_CFG"
  echo "}" >> "$TMP_GRUB_CFG"
  echo "menuentry 'Boot from next volume' {" >> "$TMP_GRUB_CFG"
  echo "  exit 1" >> "$TMP_GRUB_CFG"
  echo "}" >> "$TMP_GRUB_CFG"
  if [[ "$ISO_BOOT_TYPE" =~ "efi" ]]; then
    echo "menuentry 'UEFI Firmware Settings' {" >> "$TMP_GRUB_CFG"
    echo "  fwsetup" >> "$TMP_GRUB_CFG"
    echo "}" >> "$TMP_GRUB_CFG"
  fi
  print_file "$TMP_LINUX_CFG"
  print_file "$TMP_GRUB_CFG"
  if [ "$TEST_MODE" = "false" ]; then
    sudo cp $TMP_LINUX_CFG $ISO_LINUX_CFG
    sudo cp $TMP_GRUB_CFG $ISO_GRUB_CFG
  fi
}

# Function: prepare_kickstart_iso
#
# Prepare kickstart ISO (e.g. Rocky Linux)

prepare_kickstart_iso () {
  mount_iso
  copy_iso
  prepare_kickstart_files
  prepare_kickstart_grub_menu
  create_kickstart_iso
  unmount_iso
}
