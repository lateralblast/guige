#!/usr/bin/env bash

# shellcheck disable=SC2034
# shellcheck disable=SC2129
# shellcheck disable=SC2153
# shellcheck disable=SC2154

# Function: create_kickstart_iso
#
# Create kickstart ISO (e.g. Rocky Linux)

create_kickstart_iso () {
  if [ ! -f "/usr/bin/xorriso" ]; then
    install_required_packages
  fi
  if [ "${options['testmode']}" = "false" ]; then
    handle_output "# Creating ISO" "TEXT"
    check_file_perms "${iso['outputfile']}"
    cd "${iso['newdir']}/cd" || exit
    sudo mkisofs -o "${iso['outputfile']}" -b isolinux/isolinux.bin -c isolinux/boot.cat \
    -boot-load-size 4 -boot-info-table -no-emul-boot -eltorito-alt-boot \
    -eltorito-boot images/efiboot.img -no-emul-boot -R -J -V "${iso['label']}" -T .
    check_file_perms "${iso['outputfile']}"
  fi
}

# Function: create_kickstart_file
#
# Create kickstart files (e.g. Rocky Linux)

prepare_kickstart_files () {
  iso['ksdir']="${iso['newdir']}/cd/"
  include_disk_file="/tmp/first-disk.cfg"
  include_nic_file="/tmp/first-nic.cfg"
  if [ "${options['isolinuxfile']}" = "true" ] && [ "${options['autoinstall']}" = "true" ]; then
    print_file "${iso['autoinstallfile']}"
    ksvalidator "${iso['autoinstallfile']}"
    sudo cp "${iso['autoinstallfile']}" "${iso['ksdir']}"
  else
    for iso_volmgr in ${iso['volumemanager']}; do
      iso['ksfile']="${iso['workdir']}/files/${iso_volmgr}.cfg"
      date=$( date )
      echo "# Kistart file generated by ${script['name']} on ${datei}" > "${iso['ksfile']}"
      if [ "${options['mediacheck']}" = "true" ]; then
        echo "mediacheck" >> "${iso['ksfile']}"
      fi
  #    echo "${iso['installmode']}" >> "${iso['ksfile']}"
      echo "${iso['installsource']}" >> "${iso['ksfile']}"
      echo "%pre" >> "${iso['ksfile']}"
      if [ "${iso['disk']}" = "first-disk" ]; then
        if [ ! "${iso_volmgr}" = "lvm" ]; then
          echo "FIRST_DISK=\$( /bin/lsblk -x TYPE |grep disk |grep -v SWAP |sort |head -1 |awk '{print \$1}' )" > "${iso['ksfile']}"
          echo "echo \"# First Disk\" > ${include_disk_file}" >> "${iso['ksfile']}"
          echo "echo \"bootloader --timeout=${iso['grubtimeout']} --location=${iso['bootloader']} --append=\\\"${iso['kernelargs']}\\\" --boot-drive=/dev/\\$FIRST_DISK\" >> ${include_disk_file}" >> "${iso['ksfile']}"
          echo "echo \"clearpart --all --drives=/dev/\\$FIRST_DISK\" >> ${include_disk_file}" >> "${iso['ksfile']}"
          echo "echo \"part /boot --size=${iso['bootsize']} --fstype=\\\"${iso_volmgr}\\\" --ondisk=/dev/\\$FIRST_DISK\" >> ${include_disk_file}" >> "${iso['ksfile']}"
          echo "echo \"part ${iso['lvname']} --size=-1 --grow --fstype=\\\"lvmpv\\\" --ondisk=/dev/\\$FIRST_DISK\" >> ${include_disk_file}" >> "${iso['ksfile']}"
          echo "echo \"part /boot/efi --size=${iso['bootsize']} --asprimary --fstype=\\\"efi\\\" --ondisk=/dev/\\$FIRST_DISK\" >> ${include_disk_file}" >> "${iso['ksfile']}"
        fi
      fi
      if [ "${iso['nic']}" = "first-nic" ]; then
        echo "echo\"# First NIC\" > ${include_nic_file}" >> "${iso['ksfile']}"
        echo "FIRST_NIC=\$(lshw -class network -short |awk '{print \$2}' |grep ^e |head -1)\" >> ${include_nic_file}" >> "${iso['ksfile']}"
      fi
      echo "%end" >> "${iso['ksfile']}"
      echo "lang ${iso['locale']}" >> "${iso['ksfile']}"
      echo "keyboard ${iso['country']}" >> "${iso['ksfile']}"
      echo "timezone --utc ${iso['timezone']}" >> "${iso['ksfile']}"
      echo "firstboot --${options['firstboot']}" >> "${iso['ksfile']}"
      if [ "${iso_volmgr}" = "lvm" ]; then
        echo "autopart --type=lvm" >> "${iso['ksfile']}"
      else
        if [ "${iso['disk']}" = "first-disk" ]; then
          echo "%include ${include_disk_file}" >> "${iso['ksfile']}"
        else
          echo "bootloader --timeout=${iso['grubtimeout']} --location=${iso['bootloader']} --append=\"${iso['kernelargs']}\" --boot-drive=${iso['disk']}" >> "${iso['ksfile']}"
          echo "clearpart --all --drives=${iso['disk']}" >> "${iso['ksfile']}"
          echo "part /boot --size=${iso['bootsize']} --fstype=\"${iso_volmgr}\" --ondisk=${iso['disk']}" >> "${iso['ksfile']}"
          echo "part ${iso['lvname']} --size=-1 --grow --fstype=\"${iso_volmgr}\" --ondisk=${iso['disk']}" >> "${iso['ksfile']}"
          echo "part /boot/efi --size=${iso['bootsize']} --asprimary --fstype=\"efi\" --ondisk=${iso['disk']}" >> "${iso['ksfile']}"
        fi
        echo "volgroup ${iso['vgname']} --pesize=${iso['pesize']} ${iso['lvname']}" >> "${iso['ksfile']}"
        echo "logvol / --fstype ${iso_volmgr} --vgname ${iso['vgname']} --size=${iso['rootsize']} --name=root" >> "${iso['ksfile']}"
        echo "logvol swap --vgname ${iso['vgname']} --size=${iso['swapsize']} --name=swap" >> "${iso['ksfile']}"
      fi
  #    echo "auth --enableshadow --passalgo=${iso['passwordalgorithm']}" >> "${iso['ksfile']}"
      echo "selinux --${iso['selinux']}" >> "${iso['ksfile']}"
      if [ "${iso['firewall']}" = "enabled" ]; then
        echo "firewall --${iso['firewall']} --service=${iso['allowservice']}" >> "${iso['ksfile']}"
      else
        echo "firewall --${iso['firewall']}" >> "${iso['ksfile']}"
      fi
      if [ "${iso['nic']}" = "first-nic" ]; then
        network="network --hostname=${iso['hostname']} --bootproto=${iso['bootproto']} --device=\$FIRST_NIC --onboot=${iso['onboot']}"
      else
        network="network --hostname=${iso['hostname']} --bootproto=${iso['bootproto']} --device=${iso['nic']} --onboot=${iso['onboot']}"
      fi
      if [ "${options['ipv4']}" = "false" ]; then
        network="${network} --noipv4"
      fi
      if [ "${options['ipv6']}" = "false" ]; then
        network="${network} --noipv6"
      fi
      if [ "${options['activate']}" = "true" ]; then
        network="${network} --activate"
      else
        network="${network} --no-activate"
      fi
      if [ "${options['defaultroute']}" = "false" ]; then
        network="${network} --nodefroute"
      fi
      if [ "${options['dhcp']}" = "false" ]; then
        network="${network} --ip=${iso['ip']} --netmask=${iso['netmask']} --gateway=${iso['gateway']} --nameserver=${iso['dns']}"
      fi
      if [ "${iso['nic']}" = "first-nic" ]; then
        echo "%include ${include_nic_file}" >> "${iso['ksfile']}"
        echo "echo \"${network}\" >> ${include_nic_file}" >> "${iso['ksfile']}"
      else
        echo "$network" >> "${iso['ksfile']}"
      fi
      echo "services --enabled=${iso['enableservice']} --disabled=${iso['disableservice']}" >> "${iso['ksfile']}"
      if [ "${options['plaintextpassword']}" = "true" ]; then
        root_pw="rootpw --plaintext ${iso['password']}"
        user_pw="user --name=${iso['username']} --group=${iso['groups']} --password=${iso['password']} --plaintext --gecos=\"${iso['gecos']}\"" >> "${iso['ksfile']}"
        ssh_pw="sshpw --username=${iso['installusername']} ${iso['installpassword']}"
      else
        root_pw="rootpw --iscrypted ${iso['passwordcrypt']}" >> "${iso['ksfile']}"
        user_pw="user --name=${iso['username']} --group=${iso['groups']} --password=${iso['passwordcrypt']} --iscrypted --gecos=\"${iso['gecos']}\"" >> "${iso['ksfile']}"
        ssh_pw="sshpw --username=${iso['installusername']} --iscrypted --password=${iso['installpasswordcrypt']}"
      fi
      if [ "${options['lockroot']}" = "true" ]; then
        root_pw="$root_pw --lock"
      fi
      echo "${root_pw}" >> "${iso['ksfile']}"
      echo "${user_pw}" >> "${iso['ksfile']}"
      if [ "${options['installuser']}" = "true" ]; then
        echo "${ssh_pw}" >> "${iso['ksfile']}"
      fi
      echo "%packages" >> "${iso['ksfile']}"
      for package in ${iso['packages']}; do
        echo "${package}" >> "${iso['ksfile']}"
      done
      echo "%end" >> "${iso['ksfile']}"
      print_file "${iso['ksfile']}"
      if [ -n "$( command -v ksvalidator )" ]; then
        ksvalidator "${iso['ksfile']}"
      fi
      if [ "${options['testmode']}" = "false" ]; then
        sudo cp "${iso['ksfile']}" "${iso['ksdir']}"
      fi
    done
    if [ "${options['autoinstall']}" = "true" ]; then
      if [ -n "$( command -v ksvalidator )" ]; then
        ksvalidator "${iso['autoinstallfile']}"
      fi
      print_file "${iso['autoinstallfile']}"
      if [ "${options['testmode']}" = "false" ]; then
        sudo cp "${iso['autoinstallfile']}" "${iso['ksdir']}/custom.cfg"
      fi
    fi
  fi
}

# Function: prepare_kickstart_iso['grubmenu']}
#
# Prepare kickstart grub, isolinux, etc files

prepare_kickstart_grubmenu () {
  tmp_linux_cfg="${iso['workdir']}/files/isolinux.cfg"
  tmp_grub_cfg="${iso['workdir']}/files/grub.cfg"
  iso_linux_cfg="${iso['newdir']}/cd/isolinux/isolinux.cfg"
  iso_grub_cfg="${iso['newdir']}/cd/EFI/BOOT/grub.cfg"
  iso['label']="${iso['realname']}-${iso['majorrelease']}-${iso['minorrelease']}-${iso['arch']}-${iso['type']}"
  iso_repo_dir="/run/install/repo"
  echo "default ${iso['grubmenu']}" > "${tmp_linux_cfg}"
  counter=0
  iso['kernelserialargs']="console=${iso['serialporta']},${iso['serialportspeeda']} console=${iso['serialportb']},${iso['serialportspeedb']}"
  if [ "${options['ksquiet']}" = "true" ]; then
    iso['kernelargs']="${iso['kernelargs']} quiet"
  fi
  if [ "${options['kstext']}" = "true" ]; then
    iso['kernelargs']="${iso['kernelargs']} inst.text"
  fi
  if [ "${options['isolinuxfile']}" = "true" ]; then
    print_file "${iso['isolinuxfile']}"
    print_file "${iso['grubfile']}"
    if [ "${options['testmode']}" = "false" ]; then
      sudo cp "${iso['isolinuxfile']}" "${iso_linux_cfg}"
      sudo cp "${iso['grubfile']}" "${iso_grub_cfg}"
    fi
  else
    for iso_volmgr in ${iso['volumemanager']}; do
      if ! [ "${iso_volmgr}" = "custom" ]; then
        echo "label ${counter}" >> "${tmp_linux_cfg}"
        echo "  menu label ^${iso['volid']}:${iso_volmgr}:${iso['disk']}:${iso['nic']} (${iso['kernelargs']})" >> "${tmp_linux_cfg}"
        echo "  kernel vmlinuz" >> "${tmp_linux_cfg}"
        echo "  append initrd=initrd.img inst.stage2=hd:LABEL=${iso['label']} ${iso['kernelargs']} inst.ks=hd:LABEL=${iso['label']}:/${iso_volmgr}.cfg" >> "${tmp_linux_cfg}"
        counter=$(( counter+1 ))
      fi
    done
    if [ "${options['autoinstall']}" = "true" ]; then
      echo "label custom" >> "${tmp_linux_cfg}"
      echo "  menu label ^${iso['volid']}:custom (${iso['kernelargs']})" >> "${tmp_linux_cfg}"
      echo "  kernel vmlinuz" >> "${tmp_linux_cfg}"
      echo "  append initrd=initrd.img inst.stage2=hd:LABEL=${iso['label']} ${iso['kernelargs']} inst.ks=hd:LABEL=${iso['label']}:/custom.cfg" >> "${tmp_linux_cfg}"
    fi
    echo "label install" >> "${tmp_linux_cfg}"
    echo "  menu label ^Install a Rocky Linux system" >> "${tmp_linux_cfg}"
    echo "  kernel vmlinuz" >> "${tmp_linux_cfg}"
    echo "  append initrd=initrd.img inst.stage2=hd:LABEL=${iso['label']} ${iso['kernelargs']}" >> "${tmp_linux_cfg}"
    echo "label rescue" >> "${tmp_linux_cfg}"
    echo "  menu label ^Rescue a Rocky Linux system" >> "${tmp_linux_cfg}"
    echo "  kernel vmlinuz" >> "${tmp_linux_cfg}"
    echo "  append initrd=initrd.img inst.stage2=hd:LABEL=${iso['label']} ${iso['kernelargs']}" >> "${tmp_linux_cfg}"
    echo "label memtest" >> "${tmp_linux_cfg}"
    echo "  menu label Test ^Memory" >> "${tmp_linux_cfg}"
    echo "  kernel memtest" >> "${tmp_linux_cfg}"
    echo "label hd" >> "${tmp_linux_cfg}"
    echo "  menu label ^Boot from first hard drive" >> "${tmp_linux_cfg}"
    echo "  localboot 0x80" >> "${tmp_linux_cfg}"
    print_file "${tmp_linux_cfg}"
    if [ "${options['testmode']}" = "false" ]; then
      sudo cp "${tmp_linux_cfg}" "${iso_linux_cfg}"
    fi
    echo "set timeout=${iso['grubtimeout']}" > "${tmp_grub_cfg}"
    echo "set default=${iso['grubmenu']}" >> "${tmp_grub_cfg}"
    echo "" >> "${tmp_grub_cfg}"
    echo "function load_video {" >> "${tmp_grub_cfg}"
    echo "  insmod efi_gop" >> "${tmp_grub_cfg}"
    echo "  insmod efi_uga" >> "${tmp_grub_cfg}"
    echo "  insmod video_bochs" >> "${tmp_grub_cfg}"
    echo "  insmod video_cirrus" >> "${tmp_grub_cfg}"
    echo "}" >> "${tmp_grub_cfg}"
    echo "" >> "${tmp_grub_cfg}"
    echo "load_video" >> "${tmp_grub_cfg}"
    echo "set gfxpayload=keep" >> "${tmp_grub_cfg}"
    echo "insmod gzio" >> "${tmp_grub_cfg}"
    echo "insmod part_gpt" >> "${tmp_grub_cfg}"
    echo "insmod ext2" >> "${tmp_grub_cfg}"
    echo "" >> "${tmp_grub_cfg}"
    echo "search --no-floppy --set=root -l '${iso['label']}'" >> "${tmp_grub_cfg}"
    echo "" >> "${tmp_grub_cfg}"
    if [ "${options['autoinstall']}" = "true" ]; then
      echo "menuentry '${iso['volid']}:custom (${iso['kernelserialargs']})' {" >> "${tmp_grub_cfg}"
      echo "  linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=${iso['label']} ${iso['kernelargs']} inst.ks=hd:LABEL=${iso['label']}:/custom.cfg" >> "${tmp_grub_cfg}"
      echo "  initrdefi /images/pxeboot/initrd.img" >> "${tmp_grub_cfg}"
      echo "}" >> "${tmp_grub_cfg}"
    fi
    for iso_volmgr in ${iso['volumemanager']}; do
      if ! [ "${iso_volmgr}" = "custom" ]; then
        echo "menuentry '${iso['volid']}:${iso_volmgr}:${iso['disk']}:${iso['nic']} (${iso['kernelserialargs']})' {" >> "${tmp_grub_cfg}"
        echo "  linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=${iso['label']} ${iso['kernelargs']} inst.ks=hd:LABEL=${iso['label']}:/${iso_volmgr}.cfg" >> "${tmp_grub_cfg}"
        echo "  initrdefi /images/pxeboot/initrd.img" >> "${tmp_grub_cfg}"
        echo "}" >> "${tmp_grub_cfg}"
      fi
    done
    echo "menuentry 'Install ${iso['volid']} (${iso['kernelserialargs']})' {" >> "${tmp_grub_cfg}"
    echo "  linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=${iso['label']} ${iso['kernelserialargs']}" >> "${tmp_grub_cfg}"
    echo "  initrdefi /images/pxeboot/initrd.img" >> "${tmp_grub_cfg}"
    echo "}" >> "${tmp_grub_cfg}"
    echo "menuentry 'Rescue ${iso['volid']} (${iso['kernelserialargs']})' {" >> "${tmp_grub_cfg}"
    echo "  linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=${iso['label']} ${iso['kernelserialargs']}" >> "${tmp_grub_cfg}"
    echo "  initrdefi /images/pxeboot/initrd.img" >> "${tmp_grub_cfg}"
    echo "}" >> "${tmp_grub_cfg}"
    echo "menuentry 'Boot from next volume' {" >> "${tmp_grub_cfg}"
    echo "  exit 1" >> "${tmp_grub_cfg}"
    echo "}" >> "${tmp_grub_cfg}"
    if [[ "${iso['boottype']}" =~ "efi" ]]; then
      echo "menuentry 'UEFI Firmware Settings' {" >> "${tmp_grub_cfg}"
      echo "  fwsetup" >> "${tmp_grub_cfg}"
      echo "}" >> "${tmp_grub_cfg}"
    fi
    print_file "${tmp_grub_cfg}"
    if [ "${options['testmode']}" = "false" ]; then
      sudo cp "${tmp_grub_cfg}" "${iso_grub_cfg}"
    fi
  fi
}

# Function: prepare_kickstart_iso
#
# Prepare kickstart ISO (e.g. Rocky Linux)

prepare_kickstart_iso () {
  prepare_kickstart_files
  prepare_kickstart_grubmenu
}
